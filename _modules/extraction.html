

<!DOCTYPE html>
<html class="writer-html5" lang="english" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>extraction &mdash; Using NLP for Job Data Structuring 23.05.2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=46b02b20"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Using NLP for Job Data Structuring
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../main.html">Main Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mongo_db.html">MongoDB Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sqlite.html">SQlite Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extraction.html">Extraction Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_selection.html">Model Selection and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance_explained.html">Performance Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../read_db.html">Read DB Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Using NLP for Job Data Structuring</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">extraction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for extraction</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Job Analysis Pipeline for Extracting and Categorizing Incentives</span>

<span class="sd">This module implements a comprehensive data processing pipeline that extracts, analyzes,</span>
<span class="sd">and categorizes job incentives and their descriptions from online job listings. It connects to Mongo-DB to retrieve</span>
<span class="sd">job data, processes text using Llama 3.2 for information extraction, classifies incentives</span>
<span class="sd">using Sentence-Transformers, and stores results in a SQLite-DB.</span>

<span class="sd">Key components:</span>

<span class="sd">    * Mongo-DB data extraction with bson handling</span>
<span class="sd">    * Location normalization and geocoding with offline database</span>
<span class="sd">    * Synonym handling and regex-extraction for non-benefits related data</span>
<span class="sd">    * Incentive extraction, industry category detection, and experience knowledge extraction using LLMs</span>
<span class="sd">    * Incentive Classification using Sentence-Transformer with few-shot learning and context information</span>
<span class="sd">    * Memory-efficient batch processing and model offloading/cleaning</span>

<span class="sd">The pipeline is designed to handle different job portal formats (stepstone, indeed) and</span>
<span class="sd">implements robust error handling and fallback mechanisms throughout the extraction process.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">login</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">json_repair</span><span class="w"> </span><span class="kn">import</span> <span class="n">repair_json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForCausalLM</span><span class="p">,</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_database</span><span class="p">,</span> <span class="n">insert_or_replace_job</span><span class="p">,</span> <span class="n">job_exists</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deep_translator</span><span class="w"> </span><span class="kn">import</span> <span class="n">GoogleTranslator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mongo_db</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_mongo_jobs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>


<span class="c1">#log into Hugging Face for Model Download</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Force reload with override</span>
<span class="n">hf_api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HF_API_KEY&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">hf_api_key</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: HF_API_KEY not found in environment variables&quot;</span><span class="p">)</span>

<span class="n">login</span><span class="p">(</span><span class="n">hf_api_key</span><span class="p">)</span>



<span class="c1"># Predefined incentive categories</span>
<span class="n">INCENTIVE_CATEGORIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Gehalt_anhand_von_Tarifklassen&quot;</span><span class="p">,</span>	<span class="s2">&quot;Überstundenvergütung&quot;</span><span class="p">,</span>	<span class="s2">&quot;Gehaltserhöhungen&quot;</span><span class="p">,</span>
	<span class="s2">&quot;Aktienoptionen_Gewinnbeteiligung&quot;</span><span class="p">,</span>	<span class="s2">&quot;Boni&quot;</span><span class="p">,</span> <span class="s2">&quot;Sonderzahlungen&quot;</span><span class="p">,</span>	<span class="s2">&quot;13. Gehalt&quot;</span><span class="p">,</span>	<span class="s2">&quot;Betriebliche_Altersvorsorge&quot;</span><span class="p">,</span>	<span class="s2">&quot;Flexible_Arbeitsmodelle&quot;</span><span class="p">,</span>	<span class="s2">&quot;Homeoffice&quot;</span><span class="p">,</span>
	<span class="s2">&quot;Weiterbildung_und_Entwicklungsmöglichkeiten&quot;</span><span class="p">,</span><span class="s2">&quot;Gesundheit_und_Wohlbefinden&quot;</span><span class="p">,</span> <span class="s2">&quot;Finanzielle_Vergünstigungen&quot;</span><span class="p">,</span> <span class="s2">&quot;Mobilitätsangebote&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Verpflegung&quot;</span><span class="p">,</span> <span class="s2">&quot;Arbeitsumfeld_Ausstattung&quot;</span><span class="p">,</span> <span class="s2">&quot;Zusätzliche_Urlaubstage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Familien_Unterstützung&quot;</span><span class="p">,</span> <span class="s2">&quot;Onboarding_und_Mentoring_Programme&quot;</span><span class="p">,</span> <span class="s2">&quot;Teamevents_Firmenfeiern&quot;</span><span class="p">,</span> <span class="s2">&quot;others&quot;</span><span class="p">,</span> <span class="s2">&quot;non_incentive&quot;</span> 
<span class="p">]</span>


<span class="c1">#get the benefits text from stepstone and indeed structure</span>
<div class="viewcode-block" id="get_benefits_text">
<a class="viewcode-back" href="../extraction.html#extraction.get_benefits_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_benefits_text</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract benefits text from job data for LLM processing.</span>
<span class="sd">    </span>
<span class="sd">    This function extracts benefits-related text from job listings in different formats depending on the job protal, the data is from.</span>

<span class="sd">    The function handles two main data structures:</span>

<span class="sd">    1. Stepstone format with &#39;lists&#39; containing &#39;content/benefits&#39;</span>
<span class="sd">    2. Indeed format with &#39;paragraphs&#39; as either list or dictionary</span>
<span class="sd">    </span>
<span class="sd">    If no benefits text is found in either structure, an empty string is returned.</span>

<span class="sd">    This text passages are later used for the :func:`incentive extraction&lt;extraction.process_jobs&gt;` as input for the corresponding prompt.</span>
<span class="sd">    </span>
<span class="sd">    :param job: Job listing data containing benefits information</span>
<span class="sd">    :type job: dict</span>
<span class="sd">    :return: Concatenated string of benefits text, separated by newlines</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">benefits_texts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="s1">&#39;content/benefits&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]:</span>
        <span class="n">benefits</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">][</span><span class="s1">&#39;content/benefits&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">benefits</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">benefits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">benefits</span><span class="p">)</span>
    <span class="c1">#Check for paragraphs</span>
    <span class="k">if</span> <span class="s1">&#39;paragraphs&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
        <span class="n">job_desc</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;paragraphs&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">benefits_texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">job_desc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">job_desc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">benefits_texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">section</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">benefits_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="c1"># If neither is present, return empty string</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">benefits_texts</span><span class="p">)</span></div>


<span class="c1">#get the benefits directly from the data not through the llm</span>
<div class="viewcode-block" id="get_direct_benefits">
<a class="viewcode-back" href="../extraction.html#extraction.get_direct_benefits">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_direct_benefits</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract benefits directly from the &#39;benefits&#39; array for indeed jobs.</span>
<span class="sd">    Adds them to the :func:`classification&lt;extraction.process_jobs&gt;`-function together with the incentives found by the LLM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;benefits&#39;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;benefits&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Filter out placeholder values like &quot;Nicht gefunden&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">benefit</span> <span class="k">for</span> <span class="n">benefit</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;benefits&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">benefit</span> <span class="ow">and</span> <span class="n">benefit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;nicht gefunden&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[]</span></div>




<span class="c1">#bert classification sertup</span>
<div class="viewcode-block" id="classify_incentives_with_few_shot">
<a class="viewcode-back" href="../extraction.html#extraction.classify_incentives_with_few_shot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">classify_incentives_with_few_shot</span><span class="p">(</span><span class="n">incentives</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Classify incentives using a few-shot learning approach with context implementation.</span>
<span class="sd">    </span>
<span class="sd">    This function uses a Sentence-Transformer model to compare job incentives against</span>
<span class="sd">    predefined examples for each category. It combines direct similarity matching with</span>
<span class="sd">    contextual understanding to achieve more accurate classification. (80/20 ratio)</span>

<span class="sd">    It further creates a logging-file that shows the found incentives with their </span>
<span class="sd">    regarding values and assignments. This can be used to adapt the global threshold.</span>
<span class="sd">    </span>
<span class="sd">    :param incentives: List of incentive strings to classify</span>
<span class="sd">    :type incentives: list</span>
<span class="sd">    :param device: Computation device (&#39;cuda&#39; or &#39;cpu&#39;)</span>
<span class="sd">    :type device: str</span>
<span class="sd">    :param threshold: Minimum similarity score to assign a category, defaults to 0.45</span>
<span class="sd">    :type threshold: float, optional</span>
<span class="sd">    :return: Tuple containing classification results and unmatched incentives</span>
<span class="sd">    :rtype: tuple(dict, list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;sentence-transformers/distiluse-base-multilingual-cased-v1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Define few-shot examples for each category</span>
    <span class="n">few_shot_examples</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Gehalt_anhand_von_Tarifklassen&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Gehalt nach Tarifvertrag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Attraktive Bezahlung nach jeweiligem Tarifvertrag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Tarifliche Vergütung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Vergütung entsprechend Tarifvertrag&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Überstundenvergütung&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Bezahlte Überstunden&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Überstundenausgleich&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Vergütung von Mehrarbeit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Nacht- und Feiertagszuschüsse&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Gehaltserhöhungen&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Regelmäßige Gehaltsanpassungen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Jährliche Gehaltssteigerungen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Leistungsbezogene Gehaltserhöhungen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gehaltsentwicklung nach Karrierestufen&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Aktienoptionen_Gewinnbeteiligung&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Mitarbeiteraktien zu vergünstigten Konditionen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Aktienbeteiligungsprogramm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gewinnbeteiligung am Unternehemenserfolg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Optionen zum Erwerb von Unternehmensanteilen&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Boni&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Leistungsboni für persönliche Zielerreichung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Verkaufsprovision bei Zielerreichung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Erfolgsprämien für übertroffene Umsatzziele&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Projektabschlussprämien&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Sonderzahlungen&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Leistungsprämien und Bonuszahlungen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Weihnachtsgeld und Urlaubsgeld&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Erfolgsbeteiligung am Unternehmensergebnis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sonderzuwendungen und Gratifikationen&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;13. Gehalt&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;13. Monatsgehalt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Zusätzliches volles Monatsgehalt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;13. Gehalt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Jahressonderzahlung in Höhe eines vollen Monatsgehalts&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Betriebliche_Altersvorsorge&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Betriebliche Altersvorsorge&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Beiträge zur Altersvorsorge&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Arbeitgeberzuschuss zur Altersvorsorge&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Betriebsrente und Pensionsplan&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Flexible_Arbeitsmodelle&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Flexible Arbeitszeiten&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gleitzeit mit Kernarbeitszeiten&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Individuelle Arbeitszeitmodelle&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Vertrauensarbeitszeit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;individuell anpassbare Arbeitszeiten&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Homeoffice&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Homeoffice möglich&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mobiles Arbeiten möglich&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Remote Work Option&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hybrides Arbeitsmodell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Homeoffice-Möglichkeit&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Weiterbildung_und_Entwicklungsmöglichkeiten&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Berufliche Weiterbildungsmöglichkeiten&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fort- und Weiterbildungsangebote&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Persönliche und fachliche Entwicklung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Coaching und Trainings&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Karriereprogramme&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Gesundheit_und_Wohlbefinden&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Betriebliche Gesundheitsförderung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Zuschuss zum Fitnessstudio&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gesundheitsprogramme und Vorsorgeuntersuchungen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Betriebssport&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Lauftreff&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Finanzielle_Vergünstigungen&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Mitarbeiterrabatte auf Produkte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Versicherungsleistungen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Corporate Benefits und Vorteilsprogramme&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Finanzielle Zuschüsse und Sonderkonditionen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rabattangebote&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Mobilitätsangebote&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Firmenwagen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Jobticket&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fahrtkostenzuschuss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Leasing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Zuschuss zur Bahn- oder Autofahrt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Job Rad&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Verpflegung&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Bezuschusstes Betriebsrestaurant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Kostenlose Getränke&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Essenszuschuss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Obstkorb und Kaffeeflatrate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Subventioniertes Essen&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Arbeitsumfeld_Ausstattung&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Moderne Büroausstattung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Firmenlaptop und Smartphone&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ergonomischer Arbeitsplatz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Höhenverstellbare Schreibtische&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Firmenlaptop&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Zusätzliche_Urlaubstage&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;30 Tage Urlaubsanspruch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Zusätzliche Urlaubstage über dem gesetzlichen Minimum&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sonderurlaubstage für besondere Anlässe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sabbatical-Möglichkeit&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Familien_Unterstützung&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Betriebsnahe Kita und Eltern-Kind Büros&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Zuschuss zur Kinderbetreuung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Familienfreundliche Arbeitszeiten&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Wiedereinstiegsprogramme nach Elternzeit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Kitaplätze&quot;</span>
        
    <span class="p">],</span>
    <span class="s2">&quot;Onboarding_und_Mentoring_Programme&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Individuelle Einarbeitung und Onboarding&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mentorenprogramm für neue Mitarbeiter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Strukturierte Einarbeitung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Patenschaftsprogramm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mentoring&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Onboardingtag und individuelles Einarbeitungsprogramm&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Teamevents_Firmenfeiern&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Teamevents&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Firmenfeiern und Betriebsausflüge&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Teambuilding-Aktivitäten&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gemeinsame Mittagessen und Afterwork-Events&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Weihnachstfeiern und Sommerfeste&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Kulturevents&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;non_incentive&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Gehalt anzeigen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Teilzeit möglich&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Feste Anstellung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Tolles Teamwork und ﬂache Hierarchien sichern kurze Kommunikationswege&quot;</span><span class="p">,</span>
        <span class="s2">&quot;freundschaftliche Atmosphäre&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gemeinsame Zeit&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
    
    <span class="c1"># Define category contexts (separate from examples)</span>
    <span class="n">category_contexts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Gehalt_anhand_von_Tarifklassen&quot;</span><span class="p">:</span> <span class="s2">&quot;Compensation based on collective bargaining agreements or tariff classifications, providing standardized salary structures according to industry standards&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Überstundenvergütung&quot;</span><span class="p">:</span> <span class="s2">&quot;Compensation for work performed beyond regular working hours, including overtime pay, time off in lieu, or special allowances for night or holiday work&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Gehaltserhöhungen&quot;</span><span class="p">:</span> <span class="s2">&quot;Regular or performance-based salary increases, including annual raises, systematic salary reviews, salary development frameworks, or regular feedback processes that impact compensation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Aktienoptionen_Gewinnbeteiligung&quot;</span><span class="p">:</span> <span class="s2">&quot;Opportunities for employees to own company shares or stock options, including employee stock purchase plans, equity compensation, or discounted company shares&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Boni&quot;</span><span class="p">:</span> <span class="s2">&quot;Performance-based additional payments that reward individual or company achievements, typically variable in amount and directly tied to reaching specific targets or goals. Examples include sales commissions, performance bonuses, and profit-sharing payments.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sonderzahlungen&quot;</span><span class="p">:</span> <span class="s2">&quot;One-time or regular additional payments beyond the normal salary that are typically tied to specific occasions, celebrations, or as general appreciation. These include holiday bonuses, vacation allowances, anniversary payments, and special situation payments like inflation compensation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;13. Gehalt&quot;</span><span class="p">:</span> <span class="s2">&quot;An additional full month&#39;s salary paid once per year, separate from regular monthly payments and distinct from other bonuses or special payments&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Betriebliche_Altersvorsorge&quot;</span><span class="p">:</span> <span class="s2">&quot;Employer-sponsored retirement plans or pension schemes, including employer contributions to retirement funds, pension plans, or retirement insurance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Flexible_Arbeitsmodelle&quot;</span><span class="p">:</span> <span class="s2">&quot;Work arrangements that allow employees to vary when and how they work, including flexible start/end times, compressed work weeks, or trust-based working time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Homeoffice&quot;</span><span class="p">:</span> <span class="s2">&quot;Ability to work from home or remotely instead of commuting to an office location, including full remote work, hybrid models, or occasional work-from-home options&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Weiterbildung_und_Entwicklungsmöglichkeiten&quot;</span><span class="p">:</span> <span class="s2">&quot;Opportunities for professional growth and skill development, including training programs, educational courses or career advancement paths&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Gesundheit_und_Wohlbefinden&quot;</span><span class="p">:</span> <span class="s2">&quot;Programs and benefits focused on employee health and wellness, including fitness subsidies, wellness programs, company sports or joined sport groups&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Finanzielle_Vergünstigungen&quot;</span><span class="p">:</span> <span class="s2">&quot;Financial benefits beyond direct compensation, including employee discounts, insurance benefits, corporate perks, or financial subsidies&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mobilitätsangebote&quot;</span><span class="p">:</span> <span class="s2">&quot;Benefits related to transportation and commuting, including company cars, public transport subsidies, bicycle leasing, or parking facilities&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Verpflegung&quot;</span><span class="p">:</span> <span class="s2">&quot;Food and beverage benefits provided in the workplace, including subsidized meals, free drinks, snacks, or meal allowances&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Arbeitsumfeld_Ausstattung&quot;</span><span class="p">:</span> <span class="s2">&quot;Physical workplace environment and equipment provided to employees, including modern office furniture, technology, ergonomic equipment, or workspace design&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zusätzliche_Urlaubstage&quot;</span><span class="p">:</span> <span class="s2">&quot;Vacation days beyond the legal minimum requirement of 20 days, including extra holiday allowances, special occasion leave, sabbaticals, or extended time off&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Familien_Unterstützung&quot;</span><span class="p">:</span> <span class="s2">&quot;Benefits that support employees with family responsibilities, including childcare assistance, parental leave, family-friendly work hours, parent-child offices, family services, emergency support, or specific allowances for family events&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Onboarding_und_Mentoring_Programme&quot;</span><span class="p">:</span> <span class="s2">&quot;Structured programs to help new employees integrate into the company, including orientation processes, mentoring relationships, buddy systems, or training periods&quot;</span><span class="p">,</span>    
    <span class="s2">&quot;Teamevents_Firmenfeiern&quot;</span><span class="p">:</span> <span class="s2">&quot;Social activities and events organized by the company to foster team spirit and company culture, including team outings, company celebrations, or social gatherings&quot;</span><span class="p">,</span>
    <span class="s2">&quot;non_incentive&quot;</span><span class="p">:</span> <span class="s2">&quot;Phrases indicating employment terms and tasks rather than benefits - salary disclosures, employment types (full/part-time), or work tasks that don&#39;t constitute additional incentives&quot;</span>

<span class="p">}</span>
   
    <span class="c1"># Prepare results dictionary</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">INCENTIVE_CATEGORIES</span> <span class="k">if</span> <span class="n">cat</span> <span class="o">!=</span> <span class="s2">&quot;non_incentive&quot;</span><span class="p">}</span>  <span class="c1">#Exclude from output</span>
    <span class="n">others</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#csv file for logging</span>
    <span class="n">csv_file</span> <span class="o">=</span> <span class="s1">&#39;bert_classification_log.csv&#39;</span>
    <span class="n">write_header</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">csvfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write_header</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
            <span class="s1">&#39;incentive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;top_1_category&#39;</span><span class="p">,</span> <span class="s1">&#39;top_1_score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;top_2_category&#39;</span><span class="p">,</span> <span class="s1">&#39;top_2_score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;top_3_category&#39;</span><span class="p">,</span> <span class="s1">&#39;top_3_score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;top_4_category&#39;</span><span class="p">,</span> <span class="s1">&#39;top_4_score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;top_5_category&#39;</span><span class="p">,</span> <span class="s1">&#39;top_5_score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;best_category&#39;</span><span class="p">,</span> <span class="s1">&#39;best_score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned&#39;</span>
        <span class="p">])</span>
    
    <span class="c1"># Get embeddings for all incentives</span>
    <span class="k">if</span> <span class="n">incentives</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DETAILED CONTEXTUAL FEW-SHOT CLASSIFICATION:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        
        <span class="n">incentive_embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">incentives</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Process each category with few-shot examples</span>
        <span class="n">direct_similarities</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">context_similarities</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">examples</span> <span class="ow">in</span> <span class="n">few_shot_examples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 1. Direct example matching</span>
            <span class="n">example_embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">direct_matrix</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span>
                <span class="n">incentive_embeddings</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">example_embeddings</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">direct_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">direct_matrix</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">direct_similarities</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_max</span>
            
            <span class="c1"># 2. Context similarity (with lower weight)</span>
            <span class="n">context_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">category_contexts</span><span class="p">[</span><span class="n">category</span><span class="p">]],</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">context_matrix</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span>
                <span class="n">incentive_embeddings</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">context_embedding</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">context_similarities</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_matrix</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Combine direct and contextual similarities (with weights)</span>
        <span class="n">combined_similarities</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">few_shot_examples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># 80% direct similarity with examples, 20% contextual influence</span>
            <span class="n">combined_similarities</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">direct_similarities</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">context_similarities</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
        
        <span class="c1"># Process each incentive</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">incentive</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">incentives</span><span class="p">):</span>
            <span class="c1"># Get the best matching category for this incentive</span>
            <span class="n">best_category</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">best_similarity</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Print all similarity scores for this incentive as an overview</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Incentive: &#39;</span><span class="si">{</span><span class="n">incentive</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 5 category matches:&quot;</span><span class="p">)</span>
            
            <span class="c1"># Collect all category similarities for this incentive</span>
            <span class="n">incentive_cats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">few_shot_examples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_similarities</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">incentive_cats</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">category</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>
            
            <span class="c1"># Sort by similarity score (highest first)</span>
            <span class="n">incentive_cats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Print top 5 most similar categories</span>
            <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">incentive_cats</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">similarity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> 
                      <span class="p">(</span><span class="s2">&quot; (MATCHED)&quot;</span> <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">best_similarity</span><span class="p">:</span>
                    <span class="n">best_similarity</span> <span class="o">=</span> <span class="n">similarity</span>
                    <span class="n">best_category</span> <span class="o">=</span> <span class="n">category</span>
            
            <span class="c1"># Assign to the best category if above threshold</span>
            <span class="k">if</span> <span class="n">best_similarity</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">best_category</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → Incentive assigned to: </span><span class="si">{</span><span class="n">best_category</span><span class="si">}</span><span class="s2"> (score: </span><span class="si">{</span><span class="n">best_similarity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incentive</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → No category matched above threshold (</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">). Added to &#39;others&#39;.&quot;</span><span class="p">)</span>

            <span class="c1"># Write log row here</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">best_similarity</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="n">top5</span> <span class="o">=</span> <span class="n">incentive_cats</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">top5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">top5</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">incentive</span><span class="p">,</span>
                <span class="n">top5</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">top5</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">top5</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">top5</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">top5</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">top5</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">top5</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">top5</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">top5</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">top5</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">best_category</span><span class="p">,</span> <span class="n">best_similarity</span><span class="p">,</span>
                <span class="n">threshold</span><span class="p">,</span> <span class="n">assigned</span>
            <span class="p">])</span>

    <span class="c1">#clean up model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>  <span class="c1"># Move model back to CPU</span>
    <span class="k">del</span> <span class="n">model</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span> <span class="c1"># Clear CUDA cache</span>

    <span class="n">csvfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">others</span></div>



<span class="c1">#setup google translator for location extraction in exctract_entities_from_json</span>
<div class="viewcode-block" id="translate_text">
<a class="viewcode-back" href="../extraction.html#extraction.translate_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">translate_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate text between languages using Google Translator.</span>
<span class="sd">    </span>
<span class="sd">    This function provides text translation capabilities used for location data</span>
<span class="sd">    processing. It handles translation errors gracefully by returning the original text</span>
<span class="sd">    when translation fails.</span>
<span class="sd">    </span>
<span class="sd">    :param text: The text string to be translated</span>
<span class="sd">    :type text: str</span>
<span class="sd">    :param source: Source language code (ISO 639-1), defaults to &#39;de&#39;</span>
<span class="sd">    :type source: str, optional</span>
<span class="sd">    :param target: Target language code (ISO 639-1), defaults to &#39;en&#39;</span>
<span class="sd">    :type target: str, optional</span>
<span class="sd">    :return: Translated text or original text if translation fails</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    :raises: No exceptions are raised as errors are caught internally</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GoogleTranslator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Translation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>  <span class="c1"># Fallback to original text</span></div>



<span class="c1">#clean location string to see multiple locations     </span>
<div class="viewcode-block" id="normalize_location_string">
<a class="viewcode-back" href="../extraction.html#extraction.normalize_location_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_location_string</span><span class="p">(</span><span class="n">location_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean and standardize location strings for consistent processing.</span>
<span class="sd">    </span>
<span class="sd">    This function normalizes location strings by converting various separators to commas,</span>
<span class="sd">    removing annotations, parenthetical content, and standardizing spacing. It helps</span>
<span class="sd">    prepare location data for further processing and geocoding.</span>
<span class="sd">    </span>
<span class="sd">    :param location_str: Raw location string that may contain multiple locations</span>
<span class="sd">    :type location_str: str</span>
<span class="sd">    :return: Cleaned and standardized location string with consistent separators</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    The function performs the following transformations:</span>

<span class="sd">    1. Converts separators (semicolons, slashes, bullets) and conjunctions to commas</span>
<span class="sd">    2. Removes qualifying phrases like &quot;bei Stuttgart&quot;</span>
<span class="sd">    3. Removes parentheses and their content</span>
<span class="sd">    4. Standardizes spacing around commas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="c1"># Replace common separators with commas</span>
    <span class="n">location_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[;/\u2022]| und | oder &#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="n">location_str</span><span class="p">)</span>
    <span class="c1"># Remove non-city annotations like &quot;bei Stuttgart&quot;</span>
    <span class="n">location_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bbei\b.*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">location_str</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="c1"># Remove parentheses and their content</span>
    <span class="n">location_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(.*?\)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">location_str</span><span class="p">)</span>
    <span class="c1"># Fix spacing around commas and remove extra spaces</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*,\s*&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="n">location_str</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>



<span class="c1">#split the now cleaned locations</span>
<div class="viewcode-block" id="split_locations">
<a class="viewcode-back" href="../extraction.html#extraction.split_locations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">split_locations</span><span class="p">(</span><span class="n">normalized_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a normalized location string into individual location components.</span>
<span class="sd">    </span>
<span class="sd">    This function intelligently splits location strings on commas while handling</span>
<span class="sd">    complex cases such as parenthetical content. It preserves commas that appear</span>
<span class="sd">    within parentheses to maintain the integrity of location names that naturally</span>
<span class="sd">    contain commas.</span>
<span class="sd">    </span>
<span class="sd">    :param normalized_str: Normalized location string with comma separators</span>
<span class="sd">    :type normalized_str: str</span>
<span class="sd">    :return: List of individual location strings</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    </span>
<span class="sd">    :example:</span>
<span class="sd">        &gt;&gt;&gt; split_locations(&quot;Berlin, Frankfurt (Main), München&quot;)</span>
<span class="sd">        [&#39;Berlin&#39;, &#39;Frankfurt (Main)&#39;, &#39;München&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="c1"># Split on commas, but ignore commas in city names (e.g. &quot;Mönchengladbach&quot;)</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;,\s*(?![^(]*\))&#39;</span><span class="p">,</span> <span class="n">normalized_str</span><span class="p">)</span></div>



<span class="c1">#validate cities against the json-database before translation, to avoid mistranslations (e.g. Hannover gets then Hanover, whic is in the USA)</span>
<div class="viewcode-block" id="validate_city">
<a class="viewcode-back" href="../extraction.html#extraction.validate_city">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_city</span><span class="p">(</span><span class="n">city_name</span><span class="p">,</span> <span class="n">world_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if city exists in offline database before translating it.</span>
<span class="sd">    </span>
<span class="sd">    This function normalizes and compares city names against an offline database</span>
<span class="sd">    to verify their existence before translation. It helps prevent translation errors</span>
<span class="sd">    that could lead to geographic misidentification (e.g., translating &quot;Hannover&quot; </span>
<span class="sd">    to &quot;Hanover&quot; which would incorrectly place it in the US instead of Germany).</span>
<span class="sd">    </span>
<span class="sd">    :param city_name: Name of the city to validate</span>
<span class="sd">    :type city_name: str</span>
<span class="sd">    :param world_data: Dictionary containing hierarchical country/state/city data</span>
<span class="sd">    :type world_data: list</span>
<span class="sd">    :return: True if the city exists in the database, False otherwise</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    </span>
<span class="sd">    The function performs Unicode normalization to handle special characters like</span>
<span class="sd">    umlauts, making the comparison case-insensitive and accent-insensitive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>
    <span class="c1"># Normalize city name (e.g., handle umlauts)</span>
    <span class="n">city_lower</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">city_name</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">world_data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">country</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;cities&quot;</span><span class="p">]:</span>
                <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">city</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">city_normalized</span> <span class="o">==</span> <span class="n">city_lower</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1">#open world json-database with locations</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Access the offline states and countries database.</span>

<span class="sd">This function loads a comprehensive database of countries, states, and cities from a json-file.</span>
<span class="sd">The database is used for location validation, geocoding, and standardization throughout the</span>
<span class="sd">application, particularly for job location processing.</span>

<span class="sd">The file structure contains a hierarchical representation of:</span>

<span class="sd">- Countries</span>
<span class="sd">- States/provinces within each country</span>
<span class="sd">- Cities within each state</span>

<span class="sd">This database helps avoid API calls to external geocoding services and ensures consistent</span>
<span class="sd">location data handling even when network access is limited.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Get the directory where the current script is located</span>
<span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="s2">&quot;countries+states+cities.json&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">world_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
<span class="c1"># Mapping of Bundesländer, to avoid English Bundesländer in the databse</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Map German federal states (Bundesländer) to standardized German names.</span>

<span class="sd">This mapping dictionary provides translations from English names and common variations</span>
<span class="sd">to standardized German names for all 16 federal states of Germany. It&#39;s used to ensure</span>
<span class="sd">consistent naming in the database when processing location data that might come from</span>
<span class="sd">different sources or through translation.</span>

<span class="sd">:return: Dictionary mapping English state names and variations to standardized German names</span>
<span class="sd">:rtype: dict</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">BUNDESLAENDER_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># English to German</span>
    <span class="s2">&quot;Bavaria&quot;</span><span class="p">:</span> <span class="s2">&quot;Bayern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Lower Saxony&quot;</span><span class="p">:</span> <span class="s2">&quot;Niedersachsen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Baden-Württemberg&quot;</span><span class="p">:</span> <span class="s2">&quot;Baden-Württemberg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rhineland-Palatinate&quot;</span><span class="p">:</span> <span class="s2">&quot;Rheinland-Pfalz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Saxony&quot;</span><span class="p">:</span> <span class="s2">&quot;Sachsen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Thuringia&quot;</span><span class="p">:</span> <span class="s2">&quot;Thüringen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Hesse&quot;</span><span class="p">:</span> <span class="s2">&quot;Hessen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;North Rhine-Westphalia&quot;</span><span class="p">:</span> <span class="s2">&quot;Nordrhein-Westfalen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Saxony-Anhalt&quot;</span><span class="p">:</span> <span class="s2">&quot;Sachsen-Anhalt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Brandenburg&quot;</span><span class="p">:</span> <span class="s2">&quot;Brandenburg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mecklenburg-Western Pomerania&quot;</span><span class="p">:</span> <span class="s2">&quot;Mecklenburg-Vorpommern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Hamburg&quot;</span><span class="p">:</span> <span class="s2">&quot;Hamburg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Schleswig-Holstein&quot;</span><span class="p">:</span> <span class="s2">&quot;Schleswig-Holstein&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Saarland&quot;</span><span class="p">:</span> <span class="s2">&quot;Saarland&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Bremen&quot;</span><span class="p">:</span> <span class="s2">&quot;Bremen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Berlin&quot;</span><span class="p">:</span> <span class="s2">&quot;Berlin&quot;</span><span class="p">,</span>
    
    <span class="c1"># Add common variations</span>
    <span class="s2">&quot;Mecklenburg-Vorpommern&quot;</span><span class="p">:</span> <span class="s2">&quot;Mecklenburg-Vorpommern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;North Rhine Westphalia&quot;</span><span class="p">:</span> <span class="s2">&quot;Nordrhein-Westfalen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Northrhine-Westphalia&quot;</span><span class="p">:</span> <span class="s2">&quot;Nordrhein-Westfalen&quot;</span>
<span class="p">}</span>


<span class="c1"># Example function to fetch state and country for a city</span>
<div class="viewcode-block" id="get_state_and_country">
<a class="viewcode-back" href="../extraction.html#extraction.get_state_and_country">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_state_and_country</span><span class="p">(</span><span class="n">city_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch state and country for a given city using offline json database.</span>
<span class="sd">    </span>
<span class="sd">    This function searches through a hierarchical database of countries, states, and cities</span>
<span class="sd">    to find location information for a given city name. It performs a case-insensitive match</span>
<span class="sd">    and handles translation of state and country names to German.</span>
<span class="sd">    It first tries to find the name in the German part of the json, then switches over to a full-json search,</span>
<span class="sd">    if the name was not found in the German part.</span>
<span class="sd">    </span>
<span class="sd">    :param city_name: Name of the city to search for in the database</span>
<span class="sd">    :type city_name: str</span>
<span class="sd">    :return: Dictionary containing state and country names in German</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    </span>
<span class="sd">    The function follows these steps:</span>

<span class="sd">    1. Searches for an exact match of the city name in the database, prioritizing German cities</span>
<span class="sd">    2. If found, checks if the state name exists in BUNDESLAENDER_MAPPING</span>
<span class="sd">    3. If not in mapping, translates state name from English to German</span>
<span class="sd">    4. Translates country name from English to German if no direct German match</span>
<span class="sd">    5. Returns both in a dictionary with &quot;state&quot; and &quot;country&quot; keys</span>
<span class="sd">    6. Returns {&quot;state&quot;: &quot;Unknown&quot;, &quot;country&quot;: &quot;Unknown&quot;} if city not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#first search for geman cities</span>
    <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">world_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">country</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Germany&quot;</span><span class="p">:</span>  <span class="c1"># Zuerst in Deutschland suchen</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">country</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;cities&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">city</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">city_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="c1">#check mapping first</span>
                        <span class="n">state_de</span> <span class="o">=</span> <span class="n">BUNDESLAENDER_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="c1"># Translate state and country names to German</span>
                        <span class="k">if</span> <span class="n">state_de</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">state_de</span> <span class="o">=</span> <span class="n">GoogleTranslator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;de&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                        
                        <span class="n">country_de</span> <span class="o">=</span> <span class="n">GoogleTranslator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;de&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">country</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state_de</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;Deutschland&quot;</span><span class="p">}</span>
                    
    <span class="c1">#when there is no german city with this name go over all cities</span>
    <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">world_data</span><span class="p">:</span>  <span class="c1"># Iterate over list of countries</span>
        <span class="k">if</span> <span class="n">country</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Germany&quot;</span><span class="p">:</span> <span class="c1">#if no german city</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">country</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]:</span>  <span class="c1"># Iterate over states in each country</span>
                <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;cities&quot;</span><span class="p">]:</span>  <span class="c1"># Iterate over cities in each state</span>
                    <span class="k">if</span> <span class="n">city</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">city_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="c1">#check mapping first</span>
                        <span class="n">state_de</span> <span class="o">=</span> <span class="n">BUNDESLAENDER_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="c1"># Translate state and country names to German</span>
                        <span class="k">if</span> <span class="n">state_de</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">state_de</span> <span class="o">=</span> <span class="n">GoogleTranslator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;de&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                        
                        <span class="n">country_de</span> <span class="o">=</span> <span class="n">GoogleTranslator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;de&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">country</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state_de</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">country_de</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">}</span></div>



<span class="c1">#remove postal code from city if existnet</span>
<div class="viewcode-block" id="remove_leading_postal_code">
<a class="viewcode-back" href="../extraction.html#extraction.remove_leading_postal_code">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_leading_postal_code</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove leading postal codes from location strings.</span>
<span class="sd">    </span>
<span class="sd">    This function strips any numeric postal codes that appear at the beginning of</span>
<span class="sd">    location strings, allowing for cleaner location data processing. It matches</span>
<span class="sd">    one or more digits at the start of the string followed by optional whitespace.</span>
<span class="sd">    </span>
<span class="sd">    :param location: Location string that may contain a leading postal code</span>
<span class="sd">    :type location: str</span>
<span class="sd">    :return: Location string with any leading postal code removed</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    :example:</span>
<span class="sd">        &gt;&gt;&gt; remove_leading_postal_code(&quot;12345 Berlin&quot;)</span>
<span class="sd">        &#39;Berlin&#39;</span>
<span class="sd">        &gt;&gt;&gt; remove_leading_postal_code(&quot;Berlin&quot;)</span>
<span class="sd">        &#39;Berlin&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d+\s*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span></div>



<span class="c1">#extract company size</span>
<div class="viewcode-block" id="extract_company_size">
<a class="viewcode-back" href="../extraction.html#extraction.extract_company_size">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_company_size</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract company size information from stepstone job listings.</span>
<span class="sd">    </span>
<span class="sd">    This function searches through the &#39;CompanyInfo&#39; field in stepstone job listings</span>
<span class="sd">    to find company size information. </span>
<span class="sd">    The information is stored in the last element of the list-elements.</span>
<span class="sd">    </span>
<span class="sd">    Note that this function only works with stepstone&#39;s data structure, as indeed job</span>
<span class="sd">    listings don&#39;t provide company size information.</span>
<span class="sd">    </span>
<span class="sd">    :param job: Job listing data dictionary from Stepstone</span>
<span class="sd">    :type job: dict</span>
<span class="sd">    :return: Company size string or default value if not found</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    The function follows these steps:</span>

<span class="sd">    1. Check if &#39;CompanyInfo&#39; exists in the job data</span>
<span class="sd">    2. Iterate through each list in &#39;CompanyInfo&#39;</span>
<span class="sd">    3. Look for &quot;Unternehmensgröße&quot; label and return the next item</span>
<span class="sd">    4. If not found, try to use the last element as fallback</span>
<span class="sd">    5. Return default value if no company size information is found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_size</span> <span class="o">=</span> <span class="s2">&quot;Keine Angaben&quot;</span>
    
    <span class="c1"># look, if CompanyInfo exists</span>
    <span class="k">if</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="s1">&#39;CompanyInfo&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">info_list</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">][</span><span class="s1">&#39;CompanyInfo&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">info_list</span><span class="p">:</span>
                <span class="c1"># Return the last element of the list (if it&#39;s a string)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">info_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">default_size</span></div>



<span class="c1">#calculate company size</span>
<div class="viewcode-block" id="categorize_company_size">
<a class="viewcode-back" href="../extraction.html#extraction.categorize_company_size">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">categorize_company_size</span><span class="p">(</span><span class="n">size_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Categorize company size into eight predefined categories based on employee count.</span>
<span class="sd">    </span>
<span class="sd">    This function extracts numeric values from a company size string and maps them</span>
<span class="sd">    to standardized size categories. It handles various input formats by extracting</span>
<span class="sd">    all numbers and using the largest one as the size indicator.</span>
<span class="sd">    </span>
<span class="sd">    :param size_str: String containing company size information</span>
<span class="sd">    :type size_str: str</span>
<span class="sd">    :return: Categorized company size as a string label</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    The function uses the following size categories:</span>

<span class="sd">    - &#39;0-10&#39;: Very small companies/startups</span>
<span class="sd">    - &#39;11-50&#39;: Small companies</span>
<span class="sd">    - &#39;51-250&#39;: Medium-sized companies</span>
<span class="sd">    - &#39;251-500&#39;: Mid-large companies</span>
<span class="sd">    - &#39;501-1000&#39;: Large companies</span>
<span class="sd">    - &#39;1001-2500&#39;: Very large companies</span>
<span class="sd">    - &#39;2501-10000&#39;: Enterprise-level companies</span>
<span class="sd">    - &#39;10000+&#39;: Major corporations</span>
<span class="sd">    </span>
<span class="sd">    If no numbers are found in the input string, &#39;Keine Angaben&#39; (No information) is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    
    <span class="c1"># Define threshold values</span>
    <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0-10&#39;</span><span class="p">,</span> <span class="s1">&#39;11-50&#39;</span><span class="p">,</span> <span class="s1">&#39;51-250&#39;</span><span class="p">,</span> <span class="s1">&#39;251-500&#39;</span><span class="p">,</span> <span class="s1">&#39;501-1000&#39;</span><span class="p">,</span> <span class="s1">&#39;1001-2500&#39;</span><span class="p">,</span> <span class="s1">&#39;2501-10000&#39;</span><span class="p">,</span> <span class="s1">&#39;10000+&#39;</span><span class="p">]</span>
    
    <span class="c1"># Remove commas from the size string</span>
    <span class="n">size_str</span> <span class="o">=</span> <span class="n">size_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># extract numbers from string</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">size_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Keine Angaben&#39;</span>
    
    <span class="c1"># convert numbers to strings</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numbers</span><span class="p">))</span>
    
    <span class="c1"># Verwende die größte Zahl als Größenindikator</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
    
    <span class="c1"># find suitable lable</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="s1">&#39;Keine Angaben&#39;</span></div>



<span class="c1">#get date in dd.mm.yyyy</span>
<div class="viewcode-block" id="get_formatted_date">
<a class="viewcode-back" href="../extraction.html#extraction.get_formatted_date">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_formatted_date</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract and format the job posting date in dd.mm.yyyy format.</span>
<span class="sd">        </span>
<span class="sd">        This function retrieves the posting date from datePosted in the stepstone-data and converts it to a</span>
<span class="sd">        standardized German date format. It handles ISO 8601 formatted dates and</span>
<span class="sd">        provides a fallback to the current date when no valid date is found.</span>
<span class="sd">        </span>
<span class="sd">        :param job: Dictionary containing job listing data</span>
<span class="sd">        :type job: dict</span>
<span class="sd">        :return: Formatted date string in DD.MM.YYYY format</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        </span>
<span class="sd">        The function follows these steps:</span>

<span class="sd">        1. Attempt to extract the &#39;datePosted&#39; field from the stepstone-jobs</span>
<span class="sd">        2. If present, try to parse it as an ISO 8601 date string</span>
<span class="sd">        3. Handle timezone information by normalizing &#39;Z&#39; notation</span>
<span class="sd">        4. If parsing fails or no date is provided, use the current date as fallback</span>
<span class="sd">        </span>
<span class="sd">        This approach ensures consistent date formatting across different job board</span>
<span class="sd">        sources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datePosted&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Try to parse the datePosted field</span>
        <span class="k">if</span> <span class="n">date_str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Handles ISO 8601 format, e.g. &quot;2025-04-15T09:21:38+02:00&quot;</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">date_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># If parsing fails, fallback to current date</span>
        <span class="c1"># Fallback: use current date</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y&quot;</span><span class="p">)</span></div>



<span class="c1">#look for homeoffice directly under lists/company, look at fallback and in the end try to use the llm (s. later)</span>
<div class="viewcode-block" id="detect_homeoffice">
<a class="viewcode-back" href="../extraction.html#extraction.detect_homeoffice">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">detect_homeoffice</span><span class="p">(</span><span class="n">job_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect mentions of remote work options in job listings.</span>
<span class="sd">    </span>
<span class="sd">    This function uses a multi-stage approach to identify homeoffice/remote work</span>
<span class="sd">    options in job listings. </span>

<span class="sd">    1. Check company info section (most reliable location for this information)</span>
<span class="sd">    2. Fall back to full-text search using synonyms across all job description sections</span>
<span class="sd">    3. Return 1 if any homeoffice pattern is found by synonym-matching, 0 otherwise</span>
<span class="sd">    4. If no homeoffice is found the code overwrites the 0 with a 1 if the LLM later finds homeoffice in the text</span>
<span class="sd">    </span>
<span class="sd">    :param job_data: Job listing data dictionary</span>
<span class="sd">    :type job_data: dict</span>
<span class="sd">    :return: Binary indicator (1 if homeoffice is mentioned, 0 if not)</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    </span>
<span class="sd">    The detection follows these steps in order:</span>

<span class="sd">    This direct pattern matching approach is more efficient than directly/always using LLM-based</span>
<span class="sd">    extraction for this specific attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">homeoffice_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;homeoffice möglich&quot;</span><span class="p">,</span> <span class="s2">&quot;Homeoffice möglich&quot;</span><span class="p">,</span> <span class="s2">&quot;Homeoffice Möglich&quot;</span>
    <span class="p">]</span>
    
    <span class="c1"># Check company info section first (most reliable)</span>
    <span class="k">if</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job_data</span> <span class="ow">and</span> <span class="s1">&#39;company&#39;</span> <span class="ow">in</span> <span class="n">job_data</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]:</span>
        <span class="n">company_info</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">job_data</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">][</span><span class="s1">&#39;company&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="n">company_info</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">homeoffice_patterns</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
    
    <span class="c1"># Check full text as fallback</span>
    <span class="n">full_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;paragraphs&#39;</span> <span class="ow">in</span> <span class="n">job_data</span><span class="p">:</span>
        <span class="n">full_text</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">job_data</span><span class="p">[</span><span class="s1">&#39;paragraphs&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job_data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">job_data</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">full_text</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lst</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="n">full_text</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">homeoffice_patterns</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="mi">0</span></div>


<span class="c1">#synonyms for time_model</span>
<span class="n">ZEITMODELL_SYNONYME</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Vollzeit&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">#german</span>
        <span class="s2">&quot;vollzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;vollzeitstelle&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;ganztags&quot;</span><span class="p">,</span> <span class="s2">&quot;40 stunden&quot;</span><span class="p">,</span> <span class="s2">&quot;vollbeschäftigung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vollzeitjob&quot;</span><span class="p">,</span> <span class="s2">&quot;vollzeitarbeit&quot;</span><span class="p">,</span> <span class="s2">&quot;voll- und teilzeit&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;voll und teilzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;voll- oder teilzeit&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;voll oder teilzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;voll- &amp; teilzeit&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;voll &amp; teilzeit&quot;</span><span class="p">,</span>
        <span class="c1">#english</span>
        <span class="s2">&quot;full- and part time&quot;</span><span class="p">,</span> <span class="s2">&quot;full and part time&quot;</span>
        <span class="s2">&quot;full- &amp; part time&quot;</span><span class="p">,</span> <span class="s2">&quot;full &amp; part time&quot;</span>
        <span class="s2">&quot;full time&quot;</span><span class="p">,</span> <span class="s2">&quot;full-time&quot;</span>
        <span class="s2">&quot;full or part time&quot;</span><span class="p">,</span> <span class="s2">&quot;full- or part time&quot;</span>
         <span class="s2">&quot;40 h&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;Teilzeit&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">#german</span>
        <span class="s2">&quot;teilzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;teilzeitstelle&quot;</span><span class="p">,</span> <span class="s2">&quot;halbtags&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;20 stunden&quot;</span><span class="p">,</span> <span class="s2">&quot;teilbeschäftigung&quot;</span><span class="p">,</span>
        <span class="s2">&quot;teilzeitjob&quot;</span><span class="p">,</span> <span class="s2">&quot;teilzeitarbeit&quot;</span><span class="p">,</span> <span class="s2">&quot;reduzierte stunden&quot;</span><span class="p">,</span>
        <span class="s2">&quot;voll- und teilzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;voll und teilzeit&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;voll- oder teilzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;voll oder teilzeit&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;voll- &amp; teilzeit&quot;</span><span class="p">,</span> <span class="s2">&quot;voll &amp; teilzeit&quot;</span><span class="p">,</span>
        <span class="c1">#english</span>
        <span class="s2">&quot;full- and part time&quot;</span><span class="p">,</span> <span class="s2">&quot;full and part time&quot;</span>
        <span class="s2">&quot;full- &amp; part time&quot;</span><span class="p">,</span> <span class="s2">&quot;full &amp; part time&quot;</span>
        <span class="s2">&quot;part time&quot;</span><span class="p">,</span> <span class="s2">&quot;part-time&quot;</span>
        <span class="s2">&quot;full or part time&quot;</span><span class="p">,</span> <span class="s2">&quot;full- or part time&quot;</span>
         <span class="s2">&quot;20 h&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="c1">#synonyms for Beschäftigungsart</span>
<span class="n">BESCHAEFTIGUNGSART_SYNONYME</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Feste Anstellung&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1"># Deutsch</span>
        <span class="s2">&quot;unbefristet&quot;</span><span class="p">,</span> <span class="s2">&quot;dauerhaft&quot;</span><span class="p">,</span> <span class="s2">&quot;festanstellung&quot;</span><span class="p">,</span> <span class="s2">&quot;festangestellt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unbefristeter vertrag&quot;</span><span class="p">,</span> <span class="s2">&quot;dauerstelle&quot;</span><span class="p">,</span> <span class="s2">&quot;festvertrag&quot;</span><span class="p">,</span> <span class="s2">&quot;Feste Anstellung&quot;</span><span class="p">,</span>
        <span class="c1"># Englisch</span>
        <span class="s2">&quot;permanent&quot;</span><span class="p">,</span> <span class="s2">&quot;full-time&quot;</span><span class="p">,</span> <span class="s2">&quot;regular employment&quot;</span><span class="p">,</span> <span class="s2">&quot;indefinite contract&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;befristet&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1"># Deutsch</span>
        <span class="s2">&quot;befristeter vertrag&quot;</span><span class="p">,</span> <span class="s2">&quot;zeitlich begrenzt&quot;</span><span class="p">,</span> <span class="s2">&quot;projektbezogen&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;temporär&quot;</span><span class="p">,</span> <span class="s2">&quot;vertrag auf zeit&quot;</span><span class="p">,</span> <span class="s2">&quot;zeitvertrag&quot;</span><span class="p">,</span> <span class="s2">&quot;befristet&quot;</span><span class="p">,</span>
        <span class="c1"># Englisch</span>
        <span class="s2">&quot;fixed-term&quot;</span><span class="p">,</span> <span class="s2">&quot;temporary&quot;</span><span class="p">,</span> <span class="s2">&quot;contract-based&quot;</span><span class="p">,</span> <span class="s2">&quot;limited duration&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="c1">#synonyms for position</span>
<span class="n">POSITION_SYNONYME</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Praktikant&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">#german</span>
        <span class="s2">&quot;praktikum&quot;</span><span class="p">,</span> <span class="s2">&quot;praktikant&quot;</span><span class="p">,</span> <span class="s2">&quot;trainee&quot;</span><span class="p">,</span> <span class="s2">&quot;praktikantin&quot;</span><span class="p">,</span> <span class="s2">&quot;volontär&quot;</span><span class="p">,</span>
        <span class="c1">#english</span>
        <span class="s2">&quot;internship&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Werkstudent&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">#german</span>
        <span class="s2">&quot;werkstudent&quot;</span><span class="p">,</span> <span class="s2">&quot;werkstudentin&quot;</span><span class="p">,</span> <span class="s2">&quot;studentische hilfskraft&quot;</span><span class="p">,</span>
        <span class="c1">#english</span>
        <span class="s2">&quot;student assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;student worker&quot;</span><span class="p">,</span> <span class="s2">&quot;working student&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>


<div class="viewcode-block" id="extract_entities_from_json">
<a class="viewcode-back" href="../extraction.html#extraction.extract_entities_from_json">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_entities_from_json</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract location, company, and employment details from job listing json.</span>
<span class="sd">    </span>
<span class="sd">    This function processes job data to extract and normalize key entities including location,</span>
<span class="sd">    company information, job type, working model, and position level. It handles different</span>
<span class="sd">    data formats from various job portals (stepstone, indeed) and normalizes the extracted</span>
<span class="sd">    information into a consistent structure.</span>
<span class="sd">    </span>
<span class="sd">    The function performs several key operations:</span>

<span class="sd">    1. Extracts basic job metadata (title, URL, portal)</span>
<span class="sd">    2. Identifies company information from different data structures</span>
<span class="sd">    3. Processes location data with geocoding and translation</span>
<span class="sd">    4. Analyzes job descriptions to determine employment type and work model</span>
<span class="sd">    5. Categorizes company size and position level</span>
<span class="sd">    </span>
<span class="sd">    Time model, position level, and employment type are extracted using word-matching</span>
<span class="sd">    against predefined synonym dictionaries.</span>
<span class="sd">    </span>
<span class="sd">    :param job: Job listing data in JSON format</span>
<span class="sd">    :type job: dict</span>
<span class="sd">    :return: Dictionary containing extracted and normalized job entities</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    </span>
<span class="sd">    :raises IndexError: When accessing company_info elements that don&#39;t exist</span>
<span class="sd">    :raises KeyError: When accessing non-existent dictionary keys</span>
<span class="sd">    :raises Exception: For general errors during location processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize default values</span>
    <span class="n">company</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">job_type</span> <span class="o">=</span> <span class="s2">&quot;befristet&quot;</span>  
    <span class="n">time_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">entry_level</span> <span class="o">=</span> <span class="s2">&quot;Normaler Angestellter&quot;</span>  
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">portal_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">company_info</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="c1">#search for Job Title</span>
    <span class="n">job_title</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Job Title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_title</span><span class="p">:</span>
        <span class="n">job_title</span> <span class="o">=</span> <span class="s2">&quot;Kein Titel&quot;</span>

    <span class="c1"># Extract URL - handle both structures</span>
    <span class="k">if</span> <span class="s1">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;URL&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">]</span>
    
    <span class="c1"># Extract portal name from URL</span>
    <span class="n">portal_name</span> <span class="o">=</span> <span class="n">extract_website_name</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    
    <span class="c1"># Handle IT-Consultant JSON structure</span>
    <span class="k">if</span> <span class="s1">&#39;Company Name&#39;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;Company Name&#39;</span><span class="p">]:</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;Company Name&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="s1">&#39;company&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]:</span>
        <span class="n">company_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">][</span><span class="s1">&#39;company&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">company_info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">company_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="c1"># Extract company and location from company info</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">company_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">company_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Extract job type from company info</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="s2">&quot;Feste Anstellung&quot;</span> <span class="ow">in</span> <span class="n">company_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">job_type</span> <span class="o">=</span> <span class="s2">&quot;Feste Anstellung&quot;</span>  
    
    <span class="c1"># Handle Data-Projekt-Manager JSON structure</span>
    <span class="k">if</span> <span class="s1">&#39;jobLocationText&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobLocationText&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Clean location by removing leading postal code</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">remove_leading_postal_code</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Location after postal code removal: </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract company size and categorize it</span>
    <span class="n">company_size_raw</span> <span class="o">=</span> <span class="n">extract_company_size</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="n">company_size</span> <span class="o">=</span> <span class="n">categorize_company_size</span><span class="p">(</span><span class="n">company_size_raw</span><span class="p">)</span>

    <span class="c1"># Collect all text for further analysis</span>
    <span class="n">full_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">desc_parts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># For stepstone structure</span>
    <span class="k">if</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">full_text</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">section</span><span class="p">)</span>
    
    <span class="c1"># For indeed structure</span>
    <span class="k">if</span> <span class="s1">&#39;paragraphs&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
        <span class="n">job_desc</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paragraphs&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">desc_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">job_desc</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">job_desc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">desc_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>

    <span class="n">full_text</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">desc_parts</span><span class="p">)</span>
        
    <span class="c1"># Common text analysis for both structures</span>
    <span class="n">search_text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="c1"># Analyze time model</span>
    <span class="k">for</span> <span class="n">modell</span><span class="p">,</span> <span class="n">synonyme</span> <span class="ow">in</span> <span class="n">ZEITMODELL_SYNONYME</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#direct word matching</span>
        <span class="c1"># Remove word boundary markers for partial matching</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:\w*?)&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">syn</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;(?:\w*?)&#39;</span><span class="p">,</span> <span class="n">search_text</span><span class="p">)</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synonyme</span><span class="p">):</span>
            <span class="n">time_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modell</span><span class="p">)</span>
        <span class="c1">#Defasult zu Vollzeit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_model</span><span class="p">:</span>
        <span class="n">time_model</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Vollzeit&quot;</span><span class="p">]</span>  <span class="c1"># Standardwert, wenn nichts gefunden wurde</span>
    <span class="c1"># Deduplicate and normalize time model</span>
    <span class="n">time_model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">time_model</span><span class="p">))</span>
    <span class="n">time_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">time_model</span><span class="p">]</span>
    
    <span class="c1"># Analyze entry level</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">synonyme</span> <span class="ow">in</span> <span class="n">POSITION_SYNONYME</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#direct word matching</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">syn</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">search_text</span><span class="p">)</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synonyme</span><span class="p">):</span>
            <span class="n">entry_level</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">break</span>
    
    <span class="c1"># Analyze job type for both structures</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">syn</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">search_text</span><span class="p">)</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">BESCHAEFTIGUNGSART_SYNONYME</span><span class="p">[</span><span class="s2">&quot;Feste Anstellung&quot;</span><span class="p">]):</span>
        <span class="n">job_type</span> <span class="o">=</span> <span class="s2">&quot;Feste Anstellung&quot;</span>
    <span class="c1"># Process location data</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalize_location_string</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
    <span class="n">raw_locations</span> <span class="o">=</span> <span class="n">split_locations</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>

    <span class="n">translated_states_countries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">raw_locations</span><span class="p">:</span>
        <span class="n">clean_loc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">clean_loc</span> <span class="o">=</span> <span class="n">remove_leading_postal_code</span><span class="p">(</span><span class="n">clean_loc</span><span class="p">)</span>
        <span class="c1"># Special handling for &quot;bundesweit&quot;</span>
        <span class="k">if</span> <span class="n">clean_loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;bundesweit&#39;</span><span class="p">:</span>
            <span class="n">translated_states_countries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">clean_loc</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;bundesweit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;Germany&quot;</span>
            <span class="p">})</span>
            <span class="k">continue</span>  <span class="c1"># Skip the regular location processing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. First try with original German name</span>
            <span class="n">result_de</span> <span class="o">=</span> <span class="n">get_state_and_country</span><span class="p">(</span><span class="n">clean_loc</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result_de</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span>
                <span class="c1"># Use German results directly</span>
                <span class="n">translated_states_countries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">clean_loc</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">result_de</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">result_de</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span>
                <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 2. Fallback to English translation</span>
                <span class="n">city_en</span> <span class="o">=</span> <span class="n">translate_text</span><span class="p">(</span><span class="n">clean_loc</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">)</span>
                <span class="n">result_en</span> <span class="o">=</span> <span class="n">get_state_and_country</span><span class="p">(</span><span class="n">city_en</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">result_en</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span>
                    <span class="c1"># 3. Translate state/country back to German</span>
                    <span class="n">state_de</span> <span class="o">=</span> <span class="n">translate_text</span><span class="p">(</span><span class="n">result_en</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">],</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">)</span>
                    <span class="n">country_de</span> <span class="o">=</span> <span class="n">translate_text</span><span class="p">(</span><span class="n">result_en</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">],</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">)</span>
                    <span class="n">translated_states_countries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">clean_loc</span><span class="p">,</span>  <span class="c1"># Keep original German name</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state_de</span><span class="p">,</span>
                        <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">country_de</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Complete fallback</span>
                    <span class="n">translated_states_countries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">clean_loc</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Unbekannt&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;Unbekannt&quot;</span>
                    <span class="p">})</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing location &#39;</span><span class="si">{</span><span class="n">clean_loc</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">translated_states_countries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">clean_loc</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Unbekannt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;Unbekannt&quot;</span>
            <span class="p">})</span>



    <span class="c1"># Prepare final state and country values</span>
    <span class="n">unique_states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">translated_states_countries</span><span class="p">])</span>
    <span class="n">unique_countries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">translated_states_countries</span><span class="p">])</span>
    <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_states</span><span class="p">)</span> <span class="k">if</span> <span class="n">unique_states</span> <span class="k">else</span> <span class="s2">&quot;Unbekannt&quot;</span>
    <span class="n">country</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_countries</span><span class="p">)</span> <span class="k">if</span> <span class="n">unique_countries</span> <span class="k">else</span> <span class="s2">&quot;Unbekannt&quot;</span>

    <span class="c1">#print statements for correct extraction and connection to the mongo-db</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FINAL EXTRACTED ENTITIES:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job Title: </span><span class="si">{</span><span class="n">job_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Company: </span><span class="si">{</span><span class="n">company</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Locations: </span><span class="si">{</span><span class="n">translated_states_countries</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State: </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Country: </span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job type: </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time model: </span><span class="si">{</span><span class="n">time_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entry level: </span><span class="si">{</span><span class="n">entry_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portal: </span><span class="si">{</span><span class="n">portal_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unternehmensgröße: </span><span class="si">{</span><span class="n">company_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
         <span class="s2">&quot;job_title&quot;</span><span class="p">:</span> <span class="n">job_title</span><span class="p">,</span>
        <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">translated_states_countries</span><span class="p">,</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
        <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">country</span><span class="p">,</span>
        <span class="s2">&quot;company&quot;</span><span class="p">:</span> <span class="n">company</span><span class="p">,</span>
        <span class="s2">&quot;company_size&quot;</span><span class="p">:</span> <span class="n">company_size</span><span class="p">,</span>
        <span class="s2">&quot;job_type&quot;</span><span class="p">:</span> <span class="n">job_type</span><span class="p">,</span>
        <span class="s2">&quot;time_model&quot;</span><span class="p">:</span> <span class="n">time_model</span><span class="p">,</span>
        <span class="s2">&quot;entry_level&quot;</span><span class="p">:</span> <span class="n">entry_level</span>
    <span class="p">}</span></div>



<span class="c1">#Get portal name</span>
<div class="viewcode-block" id="extract_website_name">
<a class="viewcode-back" href="../extraction.html#extraction.extract_website_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_website_name</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the website name from the provided URL using regex pattern matching.</span>
<span class="sd">    </span>
<span class="sd">    This function attempts to extract the domain name from a URL by applying two different</span>
<span class="sd">    regex patterns. It first tries to match URLs with &#39;www&#39; prefix, then falls back to</span>
<span class="sd">    matching standard HTTP/HTTPS URLs without &#39;www&#39;.</span>
<span class="sd">    </span>
<span class="sd">    :param url: The URL from which to extract the website name</span>
<span class="sd">    :type url: str</span>
<span class="sd">    :return: The extracted website name or &#39;Unknown&#39; if no pattern matches</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    :example:</span>
<span class="sd">        &gt;&gt;&gt; extract_website_name(&quot;https://www.example.com/jobs&quot;)</span>
<span class="sd">        &#39;example&#39;</span>
<span class="sd">        &gt;&gt;&gt; extract_website_name(&quot;https://subdomain.indeed.com/job/123&quot;)</span>
<span class="sd">        &#39;indeed&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    
    <span class="c1"># Try to match www.domain.com pattern</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;www\.(.*?)\.&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Try to match domain.com pattern without www</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https?://(?:[\w-]+\.)*([\w-]+)\.com&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span></div>



<div class="viewcode-block" id="sanitize_json_response">
<a class="viewcode-back" href="../extraction.html#extraction.sanitize_json_response">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sanitize_json_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sanitize invalid escape sequences in json responses from language models.</span>
<span class="sd">    </span>
<span class="sd">    This function removes invalid escape sequences that may appear in json responses</span>
<span class="sd">    generated by large language models. It specifically targets hexadecimal escape</span>
<span class="sd">    sequences that are not valid in standard json and could cause</span>
<span class="sd">    parsing errors.</span>
<span class="sd">    </span>
<span class="sd">    :param response: Text response from a language model that may contain invalid json</span>
<span class="sd">    :type response: str</span>
<span class="sd">    :return: Sanitized response with invalid escape sequences removed</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    </span>
<span class="sd">    The function is particularly useful when processing outputs from LLMs that may</span>
<span class="sd">    hallucinate or generate malformed json with escape sequences that aren&#39;t properly</span>
<span class="sd">    encoded according to the json specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="c1"># Replace invalid \x escape sequences</span>
    <span class="n">sanitized_response</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">x[0-9A-Fa-f]</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sanitized_response</span></div>



<div class="viewcode-block" id="parse_json_response">
<a class="viewcode-back" href="../extraction.html#extraction.parse_json_response">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_json_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract and parse the first json object from the LLMs respond wheather expericne is required</span>
<span class="sd">    for the job or not.</span>
<span class="sd">    </span>
<span class="sd">    This function searches for the first json object in a text string and attempts</span>
<span class="sd">    to parse it. It&#39;s particularly useful for extracting structured data from</span>
<span class="sd">    LLM responses that might contain additional text before or after the json.</span>
<span class="sd">    </span>
<span class="sd">    :param response: Text string that may contain a json object</span>
<span class="sd">    :type response: str</span>
<span class="sd">    :return: Parsed json object as a dictionary, or empty dictionary if no valid json found</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span>
    <span class="c1"># Find the first json object in the text</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{.*?\}&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{}</span></div>



<div class="viewcode-block" id="parse_json_incentives">
<a class="viewcode-back" href="../extraction.html#extraction.parse_json_incentives">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_json_incentives</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse model response to extract incentives as a json array.</span>
<span class="sd">    </span>
<span class="sd">    This function extracts benefits/incentives from language model responses using</span>
<span class="sd">    multiple fallback strategies. It handles various response formats and potential</span>
<span class="sd">    parsing errors with a robust multi-step approach.</span>
<span class="sd">    </span>
<span class="sd">    :param response: Text response from the language model containing benefits data</span>
<span class="sd">    :type response: str</span>
<span class="sd">    :return: List of unique incentives/benefits extracted from the response</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    </span>
<span class="sd">    The function implements the following extraction strategies in order:</span>

<span class="sd">    1. Sanitizes and repairs the entire response as json</span>
<span class="sd">    2. Attempts to find and repair json objects within the response</span>
<span class="sd">    3. Extracts the benefits array directly using regex patterns</span>
<span class="sd">    4. Falls back to extracting bulleted items as a last resort</span>
<span class="sd">    </span>
<span class="sd">    All exceptions are handled internally, ensuring the function always returns</span>
<span class="sd">    a list without raising exceptions to the caller.</span>
<span class="sd">    </span>
<span class="sd">    :example:</span>
<span class="sd">        &gt;&gt;&gt; parse_json_incentives(&#39;{&quot;benefits&quot;: [&quot;Flexible hours&quot;, &quot;Health insurance&quot;]}&#39;)</span>
<span class="sd">        [&#39;Flexible hours&#39;, &#39;Health insurance&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Sanitize the response to remove invalid escape sequences</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">sanitize_json_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        
        <span class="c1"># First try to repair and parse the entire response as JSON</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repaired_json</span> <span class="o">=</span> <span class="n">repair_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">repaired_json</span><span class="p">)</span>
            
            <span class="c1"># Handle the case where result is a list of objects with &quot;benefit&quot; key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;benefit&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">):</span>
                <span class="n">benefits</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;benefit&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
                <span class="n">filtered_benefits</span> <span class="o">=</span> <span class="n">benefits</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_benefits</span><span class="p">))</span>
            
            <span class="c1"># Handle the standard case with &quot;benefits&quot; key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;benefits&quot;</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;benefits&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">benefits</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;benefits&quot;</span><span class="p">]</span>
                <span class="n">filtered_benefits</span> <span class="o">=</span> <span class="n">benefits</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_benefits</span><span class="p">))</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Full json repair attempt failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Try to find a JSON object pattern and repair it</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\{.*\})&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">repaired_json</span> <span class="o">=</span> <span class="n">repair_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">repaired_json</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;benefits&quot;</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;benefits&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">benefits</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;benefits&quot;</span><span class="p">]</span>
                    <span class="n">filtered_benefits</span> <span class="o">=</span> <span class="n">benefits</span>
                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_benefits</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;json object repair attempt failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># If that fails, try to extract the benefits array directly</span>
        <span class="n">benefits_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;benefits&quot;:\s*\[(.*?)(?:\]|}|$)&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">benefits_match</span><span class="p">:</span>
            <span class="n">benefits_str</span> <span class="o">=</span> <span class="n">benefits_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Try to repair and parse just the array part</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array_json</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">benefits_str</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
                <span class="n">repaired_array</span> <span class="o">=</span> <span class="n">repair_json</span><span class="p">(</span><span class="n">array_json</span><span class="p">)</span>
                <span class="n">benefits</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">repaired_array</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">benefits</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">filtered_benefits</span> <span class="o">=</span> <span class="n">benefits</span>
                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_benefits</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benefits array repair attempt failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Fallback to regex extraction if repair fails</span>
            <span class="n">benefits</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;([^&quot;]*)&quot;&#39;</span><span class="p">,</span> <span class="n">benefits_str</span><span class="p">)</span>
            <span class="n">filtered_benefits</span> <span class="o">=</span> <span class="n">benefits</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_benefits</span><span class="p">))</span>
        
        <span class="c1"># If all else fails, try to extract bulleted items</span>
        <span class="n">incentives</span> <span class="o">=</span> <span class="n">clean_incentives</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">incentives</span><span class="p">))</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing JSON incentives: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Fall back to extracting bullet points</span>
        <span class="n">incentives</span> <span class="o">=</span> <span class="n">clean_incentives</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">incentives</span><span class="p">))</span></div>



<div class="viewcode-block" id="clean_incentives">
<a class="viewcode-back" href="../extraction.html#extraction.clean_incentives">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_incentives</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract bulleted list items from the model response when json parsing fails.</span>
<span class="sd">    </span>
<span class="sd">    This function serves as a fallback extraction method for when structured json</span>
<span class="sd">    parsing fails. It identifies and extracts items from bulleted or numbered lists</span>
<span class="sd">    in the model&#39;s text response by looking for common list markers.</span>
<span class="sd">    </span>
<span class="sd">    :param response: Text response from the language model that may contain bulleted items</span>
<span class="sd">    :type response: str</span>
<span class="sd">    :return: List of extracted incentives/benefits from bulleted items</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    </span>
<span class="sd">    The function identifies list items by matching lines that start with:</span>

<span class="sd">    - Hyphens (-)</span>
<span class="sd">    - Asterisks (*)</span>
<span class="sd">    - Bullet points (•)</span>
<span class="sd">    - Numbered items (1., 2., etc.)</span>
<span class="sd">    </span>
<span class="sd">    It then cleans these items by removing the leading markers and whitespace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">incentives</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="c1"># Match lines starting with - * or numbers</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\s*[-*•]|\d+\.)\s*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[\s\-*•]+\s*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cleaned</span><span class="p">:</span>
                <span class="n">incentives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">incentives</span></div>




<div class="viewcode-block" id="process_jobs">
<a class="viewcode-back" href="../extraction.html#extraction.process_jobs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_jobs</span><span class="p">(</span><span class="n">insert_or_replace_job</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process job listings from Mongo-DB and store in SQLite-Database.</span>
<span class="sd">    </span>
<span class="sd">    This function implements a complete pipeline for processing job listings data:</span>

<span class="sd">    1. Extracts required experience, branche based on job title and raw-incentives/benefits using LLama</span>
<span class="sd">    2. Classifies raw-incentives/benefits using Sentence-Transformers</span>
<span class="sd">    3. Stores the processed data in a SQLite-Database</span>
<span class="sd">    </span>
<span class="sd">    For key design choices see :ref:`here&lt;Model Selection and Implementation&gt;`)</span>
<span class="sd">    </span>
<span class="sd">    :param insert_or_replace_job: Function to insert or update job records in the database</span>
<span class="sd">    :type insert_or_replace_job: callable</span>
<span class="sd">    :param batch_size: Number of jobs to process in each batch, defaults to 1</span>
<span class="sd">    :type batch_size: int, optional</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: NoneType</span>
<span class="sd">    </span>
<span class="sd">    :raises ConnectionError: If connection to Mongo-DB fails</span>
<span class="sd">    :raises RuntimeError: If model loading fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">get_mongo_jobs</span><span class="p">()</span>
    
    <span class="c1">#initialize the database, if not already excisting</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;job_analysis.db&quot;</span>
    <span class="n">create_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;created db or found excisting&quot;</span><span class="p">)</span>

    <span class="c1"># Get all jobs from Mongo-DB and convert to a list</span>
    <span class="n">mongo_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_mongo_jobs</span><span class="p">())</span>
    <span class="n">all_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span><span class="p">,</span> <span class="n">coll_name</span> <span class="ow">in</span> <span class="n">mongo_results</span><span class="p">]</span>
    <span class="n">total_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_jobs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">total_jobs</span><span class="si">}</span><span class="s2"> jobs from Mongo-DB&quot;</span><span class="p">)</span>
    
    <span class="c1"># Count for new jobs</span>
    <span class="n">new_jobs_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped_jobs_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Process jobs in batches to manage memory</span>
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_jobs</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">all_jobs</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">:</span><span class="n">batch_idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="c1">#load model outside loop</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="s2">&quot;meta-llama/Llama-3.2-3B-Instruct&quot;</span><span class="p">,</span>
                <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span> <span class="c1">#reduced due to memory constraints</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;meta-llama/Llama-3.2-3B-Instruct&quot;</span><span class="p">)</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
            
        <span class="n">generator</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s2">&quot;text-generation&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Process each job in the batch</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>  <span class="c1"># Disables gradients and reduces memory</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                <span class="c1"># Check if the job already exists in SQLite</span>
                <span class="n">mongodb_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">mongodb_id</span> <span class="ow">and</span> <span class="n">job_exists</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">mongodb_id</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job with Mongo-DB ID </span><span class="si">{</span><span class="n">mongodb_id</span><span class="si">}</span><span class="s2"> already exists in SQLite. Skipping.&quot;</span><span class="p">)</span>
                    <span class="n">skipped_jobs_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="n">new_jobs_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing new job with Mongo-DB ID: </span><span class="si">{</span><span class="n">mongodb_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Extract job description for experience-required prompt</span>
                <span class="n">desc_parts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#indeed strucuture</span>
                <span class="k">if</span> <span class="s1">&#39;paragraphs&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                    <span class="n">job_desc</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paragraphs&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">desc_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">job_desc</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">job_desc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">desc_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>
                <span class="c1">#stepstone structure</span>
                <span class="k">if</span> <span class="s1">&#39;lists&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">desc_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lst</span><span class="p">))</span>

                <span class="n">full_desc</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_parts</span><span class="p">)</span>

                <span class="c1">#print(&quot;\n&quot; + &quot;=&quot;*50 + &quot;\nFULL DESCRIPTION FOR LLM (Berufserfahrung_vorausgesetzt):\n&quot; + &quot;=&quot;*50)</span>
                <span class="c1">#print(full_desc)</span>
                
                <span class="n">entities</span> <span class="o">=</span> <span class="n">extract_entities_from_json</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                
                <span class="c1"># First phase: Extract job details</span>
                <span class="n">details_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are a helpful assistant that extracts structured information from job descriptions.</span>
<span class="s2">                Extract the following information from this text </span><span class="si">{</span><span class="n">full_desc</span><span class="si">}</span><span class="s2">:</span>

<span class="s2">                For Experience Required:</span>
<span class="s2">                - Return 1 if the job description explicitly mentions requiring professional experience</span>
<span class="s2">                - Else return 0 </span>
<span class="s2">                - Only return 0 or 1</span>

<span class="s2">                EXAMPLE OUTPUT:</span>
<span class="s2">                </span><span class="se">{{</span>
<span class="s2">                &quot;Experience_Required&quot;: 1/0</span>
<span class="s2">                </span><span class="se">}}</span>
<span class="s2">                Respond only with valid JSON. Do not write an introduction or summary.</span>
<span class="s2">                &quot;&quot;&quot;</span>
                
                <span class="n">response</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">details_prompt</span><span class="p">,</span> <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">parse_json_response</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">])</span>
                
                <span class="c1"># Print raw outputs before parsing</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RAW LLM OUTPUT (DETAILS):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">])</span>
                
                <span class="c1"># Print details response</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">JOB DETAILS ANALYSIS:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                
                <span class="c1"># Free memory</span>
                <span class="k">del</span> <span class="n">response</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
                
                <span class="c1"># Second phase: Extract incentives</span>
                <span class="n">benefits_text</span> <span class="o">=</span> <span class="n">get_benefits_text</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="c1">#direct benefits</span>
                <span class="n">direct_benefits</span> <span class="o">=</span> <span class="n">get_direct_benefits</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                
                <span class="c1"># Only benefits section</span>
                <span class="n">extraction_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Antworte ausschließlich auf Deutsch.</span>

<span class="s2">                Extrahiere alle Incentives/Benefitss aus folgender Stellenanzeige, soweit vorhanden:</span>

<span class="s2">                </span><span class="si">{</span><span class="n">benefits_text</span><span class="si">}</span>

<span class="s2">                REGELN:</span>
<span class="s2">                1. Extrahiere nur Incentives/Benefits, die sich direkt auf die Incentives/Benefits, Vergütungen oder Zusatzleistungen für Mitarbeitende beziehen (z.B. finanzielle Anreize, flexible Arbeitsmodelle, Zusatzleistungen).</span>
<span class="s2">                2. Schließe Aufgaben, Tätigkeiten, Anforderungen oder allgemeine Rollenbeschreibungen aus.</span>
<span class="s2">                3. WICHTIG: Erfinde oder ergänze KEINE Incentives/Benefits – nur exakt das übernehmen, was im Text steht.</span>
<span class="s2">                4. Vermeide Wiederholungen mit leicht abweichenden Formulierungen.</span>
<span class="s2">                5. Übernimm die Incentives/Benefits wortwörtlich aus dem Text, NICHT umformulieren.</span>
<span class="s2">                6. Gib keine allgemeinen Begriffe wie „finanzielle Anreize“, „flexible Arbeitszeitmodelle“ oder „zusätzliche Ausbildungsmöglichkeiten“ aus, wenn diese nicht wortwörtlich im Text stehen.</span>


<span class="s2">                BEISPIELE:</span>
<span class="s2">                Keine Incentives/Benefits (NICHT übernehmen!):</span>
<span class="s2">                - &quot;Herausfordernde Aufgaben&quot; → Beschreibung der Tätigkeit</span>
<span class="s2">                - &quot;Wir entwickeln innovative Lösungen&quot; → Allgemeine Aussage</span>
<span class="s2">                - &quot;Erfahrung mit Cloud-Technologien&quot; → Anforderung</span>
<span class="s2">                - &quot;Verantwortung für IT-Projekte&quot; → Aufgabenbeschreibung</span>
<span class="s2">                - &quot;Engagiertes Team&quot; -&gt; kein direkter Mitarbeitervorteil</span>
<span class="s2">                - &quot;Vollzeit/Teilzeit&quot; -&gt; Arbeitsmodelle, keine Incentives/Benefits</span>
<span class="s2">                - &quot;Gehalt&quot; -&gt; nur ein generischer Begriff ohne Aussage</span>

<span class="s2">                Gib die Antwort ausschließlich als gültiges JSON-Objekt im folgenden Format zurück und nichts anderes:</span>
<span class="s2">                </span><span class="se">{{</span>
<span class="s2">                    &quot;benefits&quot;: [</span>
<span class="s2">                        &quot;benefit 1&quot;,</span>
<span class="s2">                        &quot;benefit 2&quot;,</span>
<span class="s2">                        &quot;benefit 3&quot;</span>
<span class="s2">                    ]</span>
<span class="s2">                </span><span class="se">}}</span>

<span class="s2">                Keine Erklärungen, keine Beispiele, keine Einleitung, keine Zusammenfassung. Nur das JSON-Objekt im vorgegebenen Format!</span>
<span class="s2">                &quot;&quot;&quot;</span>
                
                <span class="n">response</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">extraction_prompt</span><span class="p">,</span> <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span> <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
                <span class="n">raw_response</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">]</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RAW LLM OUTPUT (INCENTIVES):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">])</span>
                
                <span class="n">incentives</span> <span class="o">=</span> <span class="n">parse_json_incentives</span><span class="p">(</span><span class="n">raw_response</span><span class="p">)</span>
                
                <span class="c1"># Print incentives as a list</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INCENTIVES ANALYSIS:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">incentives</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found Incentives:&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">incentives</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No incentives were found.&quot;</span><span class="p">)</span>
                
                <span class="c1"># Free memory</span>
                <span class="k">del</span> <span class="n">response</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

                <span class="c1">#Third phase: find jobs branche</span>
                <span class="n">job_title</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job_title&quot;</span><span class="p">,</span> <span class="s2">&quot;Kein Titel&quot;</span><span class="p">)</span>
                <span class="c1">#categorize the branche</span>
                <span class="n">category_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Klassifiziere diesen Job-Titel in genau eine der folgenden Kategorien:</span>
<span class="s2">                - IT: Softwareentwicklung, Programmierung, Cloud, Backend, DevOps, KI, Datenanalyse</span>
<span class="s2">                - Gesundheit: Medizin, Pflege, Pharma, Krankenhauswesen, Gesundheitswesen</span>
<span class="s2">                - Technik: Maschinenbau, Elektrotechnik, Produktion, Fertigung</span>
<span class="s2">                - Bildung &amp; Forschung: Lehre, Wissenschaft, Forschungsinstitute, Universitäten</span>
<span class="s2">                - Finanzen: Bankwesen, Versicherungen, Buchhaltung, Steuerberatung</span>
<span class="s2">                - Recht: Jura, Compliance, Notardienste, Rechtsberatung</span>
<span class="s2">                - Marketing &amp; Medien: Werbung, Journalismus, Social Media, Content Creation</span>
<span class="s2">                - Handel &amp; E-Commerce: Einzelhandel, Online-Handel, Vertrieb, E-Commerce</span>
<span class="s2">                - Bau &amp; Handwerk: Baugewerbe, Handwerksbetriebe, Sanierung</span>
<span class="s2">                - Logistik: Transport, Lagerhaltung, Supply Chain Management</span>
<span class="s2">                - Öffentlicher Dienst: Behörden, öffentliche Einrichtungen, Verwaltung</span>
<span class="s2">                - Andere: Keine Übereinstimmung mit oben genannten</span>

<span class="s2">                Job-Titel: </span><span class="si">{</span><span class="n">job_title</span><span class="si">}</span><span class="s2"> </span>

<span class="s2">                Regeln:</span>
<span class="s2">                1. Wähle die spezifischste passende Kategorie</span>
<span class="s2">                2. Bei Überschneidungen (z.B. IT in Gesundheitsbereich) primäre Branche wählen</span>
<span class="s2">                3. Im Zweifelsfall &quot;Andere&quot;</span>

<span class="s2">                Antworte NUR im JSON-Format: </span><span class="se">{{</span><span class="s2">&quot;Kategorie&quot;: &quot;&lt;Kategorie&gt;&quot;</span><span class="se">}}</span><span class="s2"> Schreibe keine Beispiele, Einleitungen oder Erklärungen.&quot;&quot;&quot;</span>

                <span class="n">category_response</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span>
                    <span class="n">category_prompt</span><span class="p">,</span>
                    <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                    <span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span>
                <span class="p">)</span>

                <span class="n">raw_output</span> <span class="o">=</span> <span class="n">category_response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">]</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{.*?\}&#39;</span><span class="p">,</span> <span class="n">raw_output</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">))</span>
                <span class="n">job_category</span> <span class="o">=</span> <span class="s2">&quot;Andere&quot;</span>
                <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_json</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">category_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">last_json</span><span class="p">)</span>
                        <span class="n">job_category</span> <span class="o">=</span> <span class="n">category_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Kategorie&quot;</span><span class="p">,</span> <span class="s2">&quot;Andere&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># Normalisierung &amp; Validierung</span>
                <span class="n">normalized</span> <span class="o">=</span> <span class="n">job_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">valid_categories_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;IT&quot;</span><span class="p">,</span> <span class="s2">&quot;Gesundheit&quot;</span><span class="p">,</span> <span class="s2">&quot;Technik&quot;</span><span class="p">,</span> <span class="s2">&quot;Bildung &amp; Forschung&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;Finanzen&quot;</span><span class="p">,</span> <span class="s2">&quot;Recht&quot;</span><span class="p">,</span> <span class="s2">&quot;Marketing &amp; Medien&quot;</span><span class="p">,</span> <span class="s2">&quot;Handel &amp; E-Commerce&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Bau &amp; Handwerk&quot;</span><span class="p">,</span> <span class="s2">&quot;Logistik&quot;</span><span class="p">,</span> <span class="s2">&quot;Öffentlicher Dienst&quot;</span><span class="p">,</span> <span class="s2">&quot;Andere&quot;</span>
                <span class="p">]]</span>

                <span class="k">if</span> <span class="n">normalized</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_categories_norm</span><span class="p">:</span>
                    <span class="n">job_category</span> <span class="o">=</span> <span class="s2">&quot;Andere&quot;</span>
                
                <span class="c1">#free memory</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

                <span class="c1">#Fourth phase: Categorize incentives with DistilBERT</span>
                <span class="n">categorized</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">INCENTIVE_CATEGORIES</span><span class="p">}</span>
                <span class="n">others</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c1">#incentives:</span>
                <span class="n">incentives</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">incentives</span><span class="p">))</span>
                    
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INCENTIVES PASSED TO CATEGORIZATION:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">incentives</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    
                <span class="c1"># Use sentence-transformer for classification</span>
                <span class="c1">#put direct incentives and llm incentives together</span>
                <span class="n">all_incentives</span> <span class="o">=</span> <span class="n">direct_benefits</span> <span class="o">+</span> <span class="n">incentives</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">COMBINED INCENTIVES (DIRECT + LLM):</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_incentives</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

                <span class="n">categorized</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="n">classify_incentives_with_few_shot</span><span class="p">(</span><span class="n">all_incentives</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.45</span><span class="p">)</span>

                <span class="c1"># Combined Homeoffice detection (rule-based + Sentence Transformers)</span>
                <span class="n">homeoffice_direct</span> <span class="o">=</span> <span class="n">detect_homeoffice</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="n">homeoffice_llm</span> <span class="o">=</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Homeoffice&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># From Sentence Transformers</span>
                <span class="n">categorized</span><span class="p">[</span><span class="s2">&quot;Homeoffice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">homeoffice_direct</span> <span class="ow">or</span> <span class="n">homeoffice_llm</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                    
                <span class="c1"># Print classification results</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DISTILBERT CLASSIFICATION RESULTS:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">categorized</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">others</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unmatched incentives:&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            
                <span class="c1"># Process locations and save to database</span>
                <span class="n">locations</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Unbekannt&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;Unbekannt&quot;</span><span class="p">}])</span>
                <span class="n">time_models</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_model&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nan&quot;</span><span class="p">])</span>
                <span class="n">entry_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entry_level&quot;</span><span class="p">,</span> <span class="s2">&quot;nan&quot;</span><span class="p">)]</span>
                
                <span class="c1"># Process each location</span>
                <span class="n">seen_locations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="c1">#initialize combo count</span>
                <span class="n">combo_count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Create row with single location</span>
                <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">time_models</span><span class="p">,</span> <span class="n">entry_levels</span><span class="p">):</span>
                    <span class="n">row_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;MongoDB_ID&#39;</span><span class="p">:</span> <span class="n">mongodb_id</span><span class="p">,</span>
                        <span class="s1">&#39;Job_URL&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Portal_Name&#39;</span><span class="p">:</span> <span class="n">extract_website_name</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
                        <span class="s1">&#39;Job_Titel&#39;</span><span class="p">:</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_title&#39;</span><span class="p">,</span> <span class="s1">&#39;Kein Titel&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Datum&#39;</span><span class="p">:</span> <span class="n">get_formatted_date</span><span class="p">(</span><span class="n">job</span><span class="p">),</span>
                        <span class="s1">&#39;Stadt&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">],</span>
                        <span class="s1">&#39;Bundesland&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">],</span>
                        <span class="s1">&#39;Land&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">],</span>
                        <span class="s1">&#39;Unternehmen&#39;</span><span class="p">:</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;company&quot;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Unternehmensgröße&#39;</span><span class="p">:</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;company_size&quot;</span><span class="p">,</span> <span class="s1">&#39;Keine Angaben&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Zeitmodell&#39;</span><span class="p">:</span> <span class="n">tm</span><span class="p">,</span>
                        <span class="s1">&#39;Position&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">,</span>
                        <span class="s1">&#39;Beschäftigungsart&#39;</span><span class="p">:</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job_type&quot;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Berufserfahrung_vorausgesetzt&#39;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Experience_Required&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Kategorie&#39;</span><span class="p">:</span> <span class="n">job_category</span><span class="p">,</span>
                        <span class="c1"># Incentives</span>
                        <span class="s1">&#39;Gehalt_anhand_von_Tarifklassen&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gehalt_anhand_von_Tarifklassen&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Überstundenvergütung&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Überstundenvergütung&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Gehaltserhöhungen&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gehaltserhöhungen&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Aktienoptionen_Gewinnbeteiligung&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Aktienoptionen_Gewinnbeteiligung&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Boni&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Boni&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Sonderzahlungen&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sonderzahlungen&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;13. Gehalt&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;13. Gehalt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Betriebliche_Altersvorsorge&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Betriebliche_Altersvorsorge&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Flexible_Arbeitsmodelle&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Flexible_Arbeitsmodelle&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Homeoffice&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Homeoffice&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Weiterbildung_und_Entwicklungsmöglichkeiten&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Weiterbildung_und_Entwicklungsmöglichkeiten&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Gesundheit_und_Wohlbefinden&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gesundheit_und_Wohlbefinden&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Finanzielle_Vergünstigungen&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Finanzielle_Vergünstigungen&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Mobilitätsangebote&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Mobilitätsangebote&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Verpflegung&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Verpflegung&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Arbeitsumfeld_Ausstattung&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Arbeitsumfeld_Ausstattung&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Zusätzliche_Urlaubstage&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Zusätzliche_Urlaubstage&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Familien_Unterstützung&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Familien_Unterstützung&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Onboarding_und_Mentoring_Programme&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Onboarding_und_Mentoring_Programme&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Teamevents_Firmenfeiern&#39;</span><span class="p">:</span> <span class="n">categorized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Teamevents_Firmenfeiern&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="c1"># Add unmatched benefits to &quot;others&quot;</span>
                        <span class="s1">&#39;others&#39;</span><span class="p">:</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
                    <span class="p">}</span>
                    
                    <span class="c1">#print examples for verification</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WRITING TO DATABASE:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1">#test für Job-Kategorie</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">KLASSIFIZIERUNGSAUSGABE:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kategorie: </span><span class="si">{</span><span class="n">job_category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM-Antwort: </span><span class="si">{</span><span class="n">category_response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Insert or replace the row in the database</span>
                    <span class="n">insert_or_replace_job</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">row_data</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">row_data</span>

                    <span class="c1"># Memory management within the location loop</span>
                    <span class="n">combo_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">combo_count</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Clear cache every 2 combinations</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

        <span class="c1"># This section should be outside all loops (location, time_model, entry_level)</span>
        <span class="c1"># Clean up models after processing the current job</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
        <span class="k">del</span> <span class="n">generator</span>
        <span class="k">del</span> <span class="n">model</span>
        <span class="k">del</span> <span class="n">tokenizer</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>  <span class="c1"># Wait for all operations to complete</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1">#control print statements to see, if the job got processed properly</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">LLAMA MODEL UNLOADED - BATCH COMPLETE</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">new_jobs_count</span><span class="si">}</span><span class="s2"> new jobs, skipped </span><span class="si">{</span><span class="n">skipped_jobs_count</span><span class="si">}</span><span class="s2"> existing jobs out of </span><span class="si">{</span><span class="n">total_jobs</span><span class="si">}</span><span class="s2"> total jobs.&quot;</span><span class="p">)</span></div>



<span class="n">process_jobs</span><span class="p">(</span><span class="n">insert_or_replace_job</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Tom Ziegler.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>